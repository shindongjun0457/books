<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook Viewer</title>

  <!-- 1) ì „ì—­ ì„¤ì •: ë°˜ë“œì‹œ ê°€ì¥ ë¨¼ì € ë¡œë“œ -->
  <script src="./config.js"></script>

  <!-- 2) PageFlip (UMD ì „ì—­ window.St) - ë¡œì»¬ ë²¤ë” -->
  <script src="./vendor/pageflip/page-flip.browser.js"></script>

  <!-- 3) ìŠ¤íƒ€ì¼ -->
  <style>
    :root { --bg:#0b0b10; --fg:#eaeaea; --muted:#9aa0a6; --ring:#222735; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);}
    header{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--ring);}
    header a{color:#9ab4ff;text-decoration:none}
    .bar{margin-left:auto;display:flex;gap:8px}
    .btn{background:#192034;border:1px solid var(--ring);color:#eaeaea;padding:8px 10px;border-radius:10px;font-size:12px;text-decoration:none}
    .btn:hover{border-color:#3b82f6}
    .wrap{height:calc(100% - 48px);display:grid;grid-template-rows:auto 1fr}
    #stageWrap{display:grid;place-items:center;height:100%;overflow:auto;padding:10px}
    #stage{width:90vw;max-width:1200px;height:72vh;background:#0f1420;border:1px solid var(--ring);border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.35)}
    #hint{color:var(--muted);text-align:center;padding:10px 0 0;font-size:12px}
    .page{background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .page img{width:100%;height:100%;object-fit:contain;display:block}
    #loader{text-align:center;color:var(--muted);padding:14px 0}
    #progress{height:6px;background:#111624;border-radius:6px;overflow:hidden;margin:8px auto;width:240px}
    #progress>div{height:100%;background:#3b82f6;width:0%;transition:width .2s}
    #error{color:#ff8686;text-align:center;padding:12px}
  </style>
</head>
<body>
  <header>
    <a href="./">â† ëª©ë¡ìœ¼ë¡œ</a>
    <strong id="title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></strong>
    <div class="bar">
      <button class="btn" id="prevBtn">ì´ì „</button>
      <button class="btn" id="nextBtn">ë‹¤ìŒ</button>
      <button class="btn" id="zoomOut">-</button>
      <button class="btn" id="zoomIn">+</button>
      <a class="btn" id="download" target="_blank" rel="noopener">ë‹¤ìš´ë¡œë“œ</a>
    </div>
  </header>

  <div class="wrap">
    <div id="stageWrap">
      <div id="stage"></div>
      <div id="hint">ì¢Œ/ìš° í™”ì‚´í‘œë¡œ ë„˜ê²¨ë³´ì„¸ìš”. ë‘ í˜ì´ì§€ ëª¨ë“œì™€ ê·¸ë¦¼ì/ë‘ê»˜ íš¨ê³¼ê°€ ì ìš©ë©ë‹ˆë‹¤.</div>
      <div id="loader">
        <div>í˜ì´ì§€ ë Œë”ë§ ì¤‘â€¦ <span id="pct">0%</span></div>
        <div id="progress"><div></div></div>
      </div>
      <div id="error" style="display:none"></div>
    </div>
  </div>

  <!-- 4) PDF.js v4 (ESM, ë¡œì»¬ ë²¤ë”) + ë Œë”ë§ ë¡œì§ì„ í•˜ë‚˜ì˜ ëª¨ë“ˆì—ì„œ ì²˜ë¦¬ -->
  <script type="module">
    import * as pdfjsLib from './vendor/pdfjs/pdf.min.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './vendor/pdfjs/pdf.worker.min.mjs';

    const showErr = (msg) => {
      console.error(msg);
      const el = document.getElementById('error');
      el.style.display = 'block';
      el.textContent = 'ë¡œë“œ ì‹¤íŒ¨: ' + msg;
    };

    try {
      // --- íŒŒë¼ë¯¸í„° / ì „ì—­ ì„¤ì • í™•ì¸ ---
      const qs   = new URLSearchParams(location.search);
      const id   = qs.get('id');
      const name = qs.get('name') || 'PDF ë¬¸ì„œ';
      document.getElementById('title').textContent = name;

      if (!id) throw new Error('URL íŒŒë¼ë¯¸í„° idê°€ ì—†ìŠµë‹ˆë‹¤.');
      if (!window.DRIVE_CONFIG || !window.DRIVE_CONFIG.API_KEY)
        throw new Error('config.jsì˜ API_KEYë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      const API_KEY = window.DRIVE_CONFIG.API_KEY;
      const fileUrl = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(id)}?alt=media&key=${encodeURIComponent(API_KEY)}`;
      document.getElementById('download').href = fileUrl;

      // --- PDF ë°”ì´ë„ˆë¦¬ ê°€ì ¸ì˜¤ê¸° (CORS/Range ì´ìŠˆ ìš°íšŒ) ---
      console.log('ğŸ” fetching:', fileUrl);
      const res = await fetch(fileUrl, { mode: 'cors' });
      if (!res.ok) throw new Error(`Drive fetch ì‹¤íŒ¨: ${res.status} ${res.statusText}`);
      const buf = await res.arrayBuffer();

      // --- PDF ì—´ê¸° ---
      const loadingTask = pdfjsLib.getDocument({
        data: buf,
        disableAutoFetch: true,
        disableStream: true,
        useSystemFonts: true,
      });
      const pdf = await loadingTask.promise;

      // --- Flipbook ì´ˆê¸°í™” ---
      const stage    = document.getElementById('stage');
      const pageFlip = new window.St.PageFlip(stage, {
        width: 600, height: 850, size: 'stretch',
        drawShadow: true, flippingTime: 350, usePortrait: false,
        startZIndex: 3, maxShadowOpacity: 0.2, showCover: true,
        mobileScrollSupport: true
      });

      // ì»¨íŠ¸ë¡¤
      document.getElementById('prevBtn').onclick = () => pageFlip.flipPrev();
      document.getElementById('nextBtn').onclick = () => pageFlip.flipNext();
      let zoom = 1;
      document.getElementById('zoomIn').onclick  = () => { zoom = Math.min(2, zoom + 0.1); stage.style.transform = `scale(${zoom})`; stage.style.transformOrigin = 'center top'; };
      document.getElementById('zoomOut').onclick = () => { zoom = Math.max(0.7, zoom - 0.1); stage.style.transform = `scale(${zoom})`; stage.style.transformOrigin = 'center top'; };

      // --- ë Œë” ì§„í–‰ë„ ---
      const total = pdf.numPages;
      const pctEl = document.getElementById('pct');
      const barEl = document.querySelector('#progress > div');
      const pages = [];

      for (let p = 1; p <= total; p++) {
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 1.6 }); // í™”ì§ˆ(1.6~2.0)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width  = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: ctx, viewport }).promise;

        pages.push(canvas.toDataURL('image/jpeg', 0.92));
        const pct = Math.round((p / total) * 100);
        pctEl.textContent = pct + '%';
        barEl.style.width = pct + '%';
      }

      // --- Flipbook ë¡œë“œ ---
      pageFlip.loadFromImages(
        pages.map(src => {
          const el = document.createElement('div');
          el.className = 'page';
          el.innerHTML = `<img src="${src}" loading="lazy" alt="page">`;
          return el;
        })
      );

      document.getElementById('loader').style.display = 'none';
    } catch (e) {
      showErr(e?.message || String(e));
    }
  </script>
</body>
</html>
