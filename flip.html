<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook Viewer</title>

  <!-- 전역 설정: 반드시 먼저 -->
  <script src="./config.js"></script>
  <!-- PageFlip (UMD: window.St) -->
  <script src="./vendor/pageflip/page-flip.browser.js"></script>

  <style>
    :root { --bg:#0b0b10; --fg:#eaeaea; --muted:#9aa0a6; --ring:#222735; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);}
    header{
      display:flex;align-items:center;gap:8px;padding:8px 10px;
      border-bottom:1px solid var(--ring);background:#0d1018;position:sticky;top:0;z-index:10
    }
    header a{color:#9ab4ff;text-decoration:none}
    .bar{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap}
    .btn{background:#192034;border:1px solid var(--ring);color:#eaeaea;
      padding:7px 10px;border-radius:10px;font-size:12px;cursor:pointer;text-decoration:none}
    .btn:hover{border-color:#3b82f6}
    /* 여백 최소화 */
    #stageWrap{height:calc(100vh - 48px);display:grid;place-items:center;overflow:auto;padding:6px}
    #stage{
      width:98vw;max-width:1500px;height:calc(100vh - 64px);
      background:#0f1420;border:1px solid var(--ring);border-radius:10px;
      box-shadow:0 10px 40px rgba(0,0,0,.35)
    }
    .page{background:#fff;display:flex;align-items:center;justify-content:center}
    .page img{width:100%;height:100%;object-fit:contain;display:block}
    #loader{text-align:center;color:var(--muted);padding:6px 0}
    #progress{height:6px;background:#111624;border-radius:6px;overflow:hidden;margin:6px auto;width:240px}
    #progress>div{height:100%;background:#3b82f6;width:0%}
    #error{color:#ff8686;text-align:center;padding:10px;display:none}
    /* 이미지 렌더링 힌트(텍스트 선명도 약간 도움) */
    .page img{
      image-rendering:-webkit-optimize-contrast;
      image-rendering:crisp-edges;
      image-rendering:pixelated; /* 브라우저별 적용 폭 다름 */
    }
  </style>
</head>
<body>
  <header>
    <a href="./">← 목록으로</a>
    <strong id="title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></strong>
    <div class="bar">
      <button class="btn" id="prevBtn">이전</button>
      <button class="btn" id="nextBtn">다음</button>
      <button class="btn" id="zoomOut">-</button>
      <button class="btn" id="zoomIn">+</button>
      <a class="btn" id="openOriginal" target="_blank" rel="noopener">원본 보기</a>
      <a class="btn" id="download" target="_blank" rel="noopener">다운로드</a>
      <!-- 품질 토글 -->
      <button class="btn" id="hdBtn" title="고해상도로 다시 그리기">선명도↑ (HD)</button>
      <button class="btn" id="sdBtn" title="빠른 표시(기본 해상도)">기본(빠름)</button>
    </div>
  </header>

  <div id="stageWrap">
    <div id="stage"></div>
    <div id="loader">
      <div>페이지 렌더링 중… <span id="pct">0%</span></div>
      <div id="progress"><div></div></div>
    </div>
    <div id="error"></div>
  </div>

  <!-- PDF.js v4 (ESM) + 렌더 로직 -->
  <script type="module">
    import * as pdfjsLib from './vendor/pdfjs/pdf.min.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './vendor/pdfjs/pdf.worker.min.mjs';

    const showErr = (msg) => {
      console.error(msg);
      const el = document.getElementById('error');
      el.style.display = 'block';
      el.textContent = '로드 실패: ' + msg;
    };

    // === 전역 상태 ===
    let pdf = null;
    let pageFlip = null;
    let pagesCache = []; // 현재 품질로 만든 dataURL 배열
    let currentQuality = 'sd'; // 'sd' | 'hd'

    // === 유틸 ===
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const stage = document.getElementById('stage');
    const pctEl = document.getElementById('pct');
    const barEl = document.querySelector('#progress > div');

    const applyZoom = (z) => {
      stage.style.transform = `scale(${z})`;
      stage.style.transformOrigin = 'center top';
    };

    // 한 페이지가 펼침 화면의 절반 폭을 차지하도록 base scale 계산 + DPR 반영
    const stageW = () => stage.clientWidth;
    const calcScale = (pageViewportWidth, mode='sd') => {
      const singleTarget = stageW() / 2; // 펼친면(두 페이지) 기준 한 면의 목표 폭
      const base = singleTarget / pageViewportWidth;
      const dprCap = mode === 'hd' ? 3.0 : 1.6; // HD는 더 고배율 허용
      const factor = Math.min(dprCap, dpr * (mode === 'hd' ? 1.6 : 1.0));
      return Math.max(1.0, base * factor);
    };

    // 캔버스 → PNG dataURL (텍스트 선명, 무손실)
    const canvasToPNG = (canvas) => canvas.toDataURL('image/png');

    async function renderAllPages(mode='sd'){
      currentQuality = mode;
      pagesCache = [];
      // 로더 ON
      document.getElementById('loader').style.display = 'block';
      pctEl.textContent = '0%';
      barEl.style.width = '0%';

      const total = pdf.numPages;
      for(let p=1;p<=total;p++){
        const page = await pdf.getPage(p);
        const vp1 = page.getViewport({ scale: 1 });
        const scale = calcScale(vp1.width, mode);
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        // 선명도 보정
        ctx.imageSmoothingEnabled = false;

        canvas.width  = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: ctx, viewport }).promise;

        pagesCache.push(canvasToPNG(canvas));

        const pct = Math.round((p / total) * 100);
        pctEl.textContent = pct + '%';
        barEl.style.width = pct + '%';
      }
      // Flipbook 반영
      if(!pageFlip){
        pageFlip = new window.St.PageFlip(stage, {
          size: 'stretch',
          width: 700, height: 1000,
          drawShadow: true, flippingTime: 350, usePortrait: false,
          showCover: true, mobileScrollSupport: true,
          maxShadowOpacity: 0.2, startZIndex: 3
        });
        // 기본 컨트롤
        document.getElementById('prevBtn').onclick = () => pageFlip.flipPrev();
        document.getElementById('nextBtn').onclick = () => pageFlip.flipNext();
        let zoom = 1;
        document.getElementById('zoomIn').onclick  = () => { zoom = Math.min(2.5, zoom + 0.1); applyZoom(zoom); };
        document.getElementById('zoomOut').onclick = () => { zoom = Math.max(0.7, zoom - 0.1); applyZoom(zoom); };
      }else{
        pageFlip.clear();
      }

      pageFlip.loadFromImages(pagesCache);
      pageFlip.on('init', () => {
        document.getElementById('loader').style.display = 'none';
      });
    }

    (async function main(){
      try{
        // 1) 파라미터/설정
        const qs   = new URLSearchParams(location.search);
        const id   = qs.get('id');
        const name = qs.get('name') || 'PDF 문서';
        document.getElementById('title').textContent = name;

        if (!id) throw new Error('URL 파라미터 id가 없습니다.');
        if (!window.DRIVE_CONFIG || !window.DRIVE_CONFIG.API_KEY)
          throw new Error('config.js의 API_KEY를 찾을 수 없습니다.');
        const API_KEY = window.DRIVE_CONFIG.API_KEY;

        const fileUrl = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(id)}?alt=media&key=${encodeURIComponent(API_KEY)}`;
        document.getElementById('download').href = fileUrl;
        document.getElementById('openOriginal').href =
          `./viewer.html?id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}`;

        // 2) PDF 가져오기
        const res = await fetch(fileUrl, { mode: 'cors' });
        if (!res.ok) throw new Error(`Drive fetch 실패: ${res.status} ${res.statusText}`);
        const buf = await res.arrayBuffer();

        // 3) PDF 열기
        const loadingTask = pdfjsLib.getDocument({
          data: buf,
          disableAutoFetch: true,
          disableStream: true,
          useSystemFonts: true,
        });
        pdf = await loadingTask.promise;

        // 4) 먼저 빠르게 SD 렌더 → 버튼으로 HD 재렌더
        await renderAllPages('sd');

        // 품질 토글 버튼
        document.getElementById('hdBtn').onclick = async () => {
          if(currentQuality === 'hd') return;
          await renderAllPages('hd'); // 고해상도 재렌더
        };
        document.getElementById('sdBtn').onclick = async () => {
          if(currentQuality === 'sd') return;
          await renderAllPages('sd'); // 기본 해상도로 재렌더
        };

        // (선택) 창 크기 변경 시 살짝 스케일만 조정
        window.addEventListener('resize', () => {
          // 필요하면 여기서 renderAllPages(currentQuality) 호출해 “진짜” 재렌더 가능(비용 큼)
        });

      }catch(e){
        showErr(e?.message || String(e));
      }
    })();
  </script>
</body>
</html>
