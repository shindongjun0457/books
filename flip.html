<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook Viewer</title>

  <!-- 전역 설정: 반드시 가장 먼저 -->
  <script src="./config.js"></script>

  <!-- PageFlip (UMD: window.St) - 로컬 벤더 -->
  <script src="./vendor/pageflip/page-flip.browser.js"></script>

  <style>
    :root { --bg:#0b0b10; --fg:#eaeaea; --muted:#9aa0a6; --ring:#222735; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);}
    header{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--ring);}
    header a{color:#9ab4ff;text-decoration:none}
    .bar{margin-left:auto;display:flex;gap:8px}
    .btn{background:#192034;border:1px solid var(--ring);color:#eaeaea;padding:8px 10px;border-radius:10px;font-size:12px;text-decoration:none}
    .btn:hover{border-color:#3b82f6}
    .wrap{height:calc(100% - 48px);display:grid;grid-template-rows:auto 1fr}
    #stageWrap{display:grid;place-items:center;height:100%;overflow:auto;padding:10px}
    #stage{width:90vw;max-width:1200px;height:72vh;background:#0f1420;border:1px solid var(--ring);border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.35)}
    #hint{color:var(--muted);text-align:center;padding:10px 0 0;font-size:12px}
    #loader{text-align:center;color:var(--muted);padding:14px 0}
    #progress{height:6px;background:#111624;border-radius:6px;overflow:hidden;margin:8px auto;width:240px}
    #progress>div{height:100%;background:#3b82f6;width:0%;transition:width .2s}
    #error{color:#ff8686;text-align:center;padding:12px;display:none}
  </style>
</head>
<body>
  <header>
    <a href="./">← 목록으로</a>
    <strong id="title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></strong>
    <div class="bar">
      <button class="btn" id="prevBtn">이전</button>
      <button class="btn" id="nextBtn">다음</button>
      <button class="btn" id="zoomOut">-</button>
      <button class="btn" id="zoomIn">+</button>
      <a class="btn" id="download" target="_blank" rel="noopener">다운로드</a>
    </div>
  </header>

  <div class="wrap">
    <div id="stageWrap">
      <div id="stage"></div>
      <div id="hint">좌/우 화살표로 넘겨보세요. 두 페이지 & 그림자/두께 효과가 적용됩니다.</div>
      <div id="loader">
        <div>페이지 렌더링 중… <span id="pct">0%</span></div>
        <div id="progress"><div></div></div>
      </div>
      <div id="error"></div>
    </div>
  </div>

  <!-- PDF.js v4 (ESM, 로컬 벤더) + 렌더 로직 -->
  <script type="module">
    import * as pdfjsLib from './vendor/pdfjs/pdf.min.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './vendor/pdfjs/pdf.worker.min.mjs';

    const showErr = (msg) => {
      console.error(msg);
      const el = document.getElementById('error');
      el.style.display = 'block';
      el.textContent = '로드 실패: ' + msg;
    };

    try {
      // 1) 파라미터/설정
      const qs   = new URLSearchParams(location.search);
      const id   = qs.get('id');
      const name = qs.get('name') || 'PDF 문서';
      document.getElementById('title').textContent = name;

      if (!id) throw new Error('URL 파라미터 id가 없습니다.');
      if (!window.DRIVE_CONFIG || !window.DRIVE_CONFIG.API_KEY)
        throw new Error('config.js의 API_KEY를 찾을 수 없습니다.');
      const API_KEY = window.DRIVE_CONFIG.API_KEY;

      const fileUrl = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(id)}?alt=media&key=${encodeURIComponent(API_KEY)}`;
      document.getElementById('download').href = fileUrl;

      // 2) PDF 바이너리 가져오기
      const res = await fetch(fileUrl, { mode: 'cors' });
      if (!res.ok) throw new Error(`Drive fetch 실패: ${res.status} ${res.statusText}`);
      const buf = await res.arrayBuffer();

      // 3) PDF 열기
      const loadingTask = pdfjsLib.getDocument({
        data: buf,
        disableAutoFetch: true,
        disableStream: true,
        useSystemFonts: true,
      });
      const pdf = await loadingTask.promise;

      // 4) PageFlip 초기화
      const stage    = document.getElementById('stage');
      const pageFlip = new window.St.PageFlip(stage, {
        width: 600,
        height: 850,
        size: 'stretch',
        drawShadow: true,
        flippingTime: 350,
        usePortrait: false,
        startZIndex: 3,
        maxShadowOpacity: 0.2,
        showCover: true,
        mobileScrollSupport: true
      });

      // 컨트롤
      document.getElementById('prevBtn').onclick = () => pageFlip.flipPrev();
      document.getElementById('nextBtn').onclick = () => pageFlip.flipNext();
      let zoom = 1;
      document.getElementById('zoomIn').onclick  = () => { zoom = Math.min(2, zoom + 0.1); stage.style.transform = `scale(${zoom})`; stage.style.transformOrigin = 'center top'; };
      document.getElementById('zoomOut').onclick = () => { zoom = Math.max(0.7, zoom - 0.1); stage.style.transform = `scale(${zoom})`; stage.style.transformOrigin = 'center top'; };

      // 5) 렌더 진행
      const total = pdf.numPages;
      const pctEl = document.getElementById('pct');
      const barEl = document.querySelector('#progress > div');
      const pages = [];

      for (let p = 1; p <= total; p++) {
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: 1.6 }); // 화질(1.4~2.0 조절)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width  = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: ctx, viewport }).promise;

        // dataURL 문자열만 push (★중요)
        pages.push(canvas.toDataURL('image/jpeg', 0.92));

        const pct = Math.round((p / total) * 100);
        pctEl.textContent = pct + '%';
        barEl.style.width = pct + '%';
      }

      // 6) Flipbook에 이미지 URL 배열로 로드 (★DOM 아님)
      pageFlip.loadFromImages(pages);

      // 초기화 시 로더 제거
      pageFlip.on('init', () => {
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'none';
      });

    } catch (e) {
      showErr(e?.message || String(e));
    }
  </script>
</body>
</html>
