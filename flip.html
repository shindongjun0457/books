<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook Viewer</title>

  <style>
    :root { --bg:#0b0b10; --fg:#eaeaea; --muted:#9aa0a6; --ring:#222735; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); }
    header { display:flex; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid var(--ring); }
    header a { color:#9ab4ff; text-decoration:none; }
    .bar { margin-left:auto; display:flex; gap:8px; }
    .btn { background:#192034; border:1px solid var(--ring); color:#eaeaea; padding:8px 10px; border-radius:10px; font-size:12px; text-decoration:none; }
    .btn:hover { border-color:#3b82f6; }
    .wrap { height:calc(100% - 48px); display:grid; grid-template-rows:auto 1fr; }
    #stageWrap { display:grid; place-items:center; height:100%; overflow:auto; }
    #stage { width: 90vw; max-width: 1200px; height: 70vh; background:#0f1420; border:1px solid var(--ring); border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,.35); }
    #hint { color:var(--muted); text-align:center; padding:10px 0 0; font-size:12px; }

    /* PageFlip 기본 스타일 보완 */
    .page { background:#fff; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .page img { width:100%; height:100%; object-fit:contain; display:block; }
    #loader { text-align:center; color:var(--muted); padding:20px; }
    #progress { height:6px; background:#111624; border-radius:6px; overflow:hidden; margin:8px auto; width:240px; }
    #progress > div { height:100%; background:#3b82f6; width:0%; transition:width .2s; }
  </style>

  <!-- PageFlip: UMD 전역(window.St) -->
<script src="./vendor/pageflip/page-flip.browser.min.js"></script>

<!-- PDF.js v4 + 렌더 로직을 한 모듈로 -->
<script type="module">
  import * as pdfjsLib from './vendor/pdfjs/pdf.min.mjs';
  pdfjsLib.GlobalWorkerOptions.workerSrc = './vendor/pdfjs/pdf.worker.min.mjs';

  // 디버깅 도움: 오류가 나면 화면에 표시
  const showErr = (msg) => {
    console.error(msg);
    const el = document.getElementById('loader');
    if (el) el.innerHTML = `<div style="color:#ff8686">${msg}</div>`;
  };

  try {
    // 1) 기본 요소/파라미터
    const qs   = new URLSearchParams(location.search);
    const id   = qs.get('id');
    const name = qs.get('name') || 'PDF 문서';

    if (!id) throw new Error('URL 파라미터 id가 없습니다.');

    const titleEl = document.getElementById('title');
    if (titleEl) titleEl.textContent = name;

    // 2) Drive 파일 URL
    const { API_KEY } = window.DRIVE_CONFIG || {};
    if (!API_KEY) throw new Error('config.js의 API_KEY를 찾을 수 없습니다.');

    const fileUrl = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(id)}?alt=media&key=${encodeURIComponent(API_KEY)}`;
    const downloadEl = document.getElementById('download');
    if (downloadEl) downloadEl.href = fileUrl;

    // 3) PDF 바이너리 받기 (여기서 네트워크에 googleapis가 찍혀야 정상)
    const res = await fetch(fileUrl, { mode: 'cors' });
    if (!res.ok) throw new Error(`Drive fetch 실패: ${res.status} ${res.statusText}`);
    const buf = await res.arrayBuffer();

    // 4) PDF 열기
    const loadingTask = pdfjsLib.getDocument({
      data: buf,
      disableAutoFetch: true,
      disableStream: true,
      useSystemFonts: true,
    });
    const pdf = await loadingTask.promise;

    // 5) PageFlip 초기화
    const stage    = document.getElementById('stage');
    const pageFlip = new window.St.PageFlip(stage, {
      width:  600,
      height: 850,
      size: "stretch",
      drawShadow: true,
      flippingTime: 350,
      usePortrait: false,
      startZIndex: 3,
      maxShadowOpacity: 0.2,
      showCover: true,
      mobileScrollSupport: true
    });

    document.getElementById("prevBtn").onclick = () => pageFlip.flipPrev();
    document.getElementById("nextBtn").onclick = () => pageFlip.flipNext();
    let zoom = 1;
    document.getElementById("zoomIn").onclick  = () => { zoom = Math.min(2, zoom + 0.1); stage.style.transform = `scale(${zoom})`; stage.style.transformOrigin = "center top"; };
    document.getElementById("zoomOut").onclick = () => { zoom = Math.max(0.7, zoom - 0.1); stage.style.transform = `scale(${zoom})`; stage.style.transformOrigin = "center top"; };

    // 6) 페이지 렌더 → 이미지 → flipbook에 로드
    const total = pdf.numPages;
    const pctEl = document.getElementById('pct');
    const barEl = document.querySelector('#progress > div');
    const pages = [];

    for (let p = 1; p <= total; p++) {
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({ scale: 1.6 }); // 화질 조절 (1.6~2.0)
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      canvas.width  = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      await page.render({ canvasContext: ctx, viewport }).promise;

      pages.push(canvas.toDataURL('image/jpeg', 0.92));

      const pct = Math.round((p / total) * 100);
      if (pctEl) pctEl.textContent = pct + '%';
      if (barEl) barEl.style.width = pct + '%';
    }

    pageFlip.loadFromImages(
      pages.map(src => {
        const el = document.createElement('div');
        el.className = 'page';
        el.innerHTML = `<img src="${src}" loading="lazy" alt="page">`;
        return el;
      })
    );

    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'none';

  } catch (e) {
    showErr(e?.message || e);
  }
</script>

</body>
</html>
