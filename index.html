<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“š Books Library</title>
  <style>
    :root { --bg:#0b0b10; --fg:#eaeaea; --muted:#9aa0a6; --card:#141822; --ring:#222735; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Arial; background:var(--bg); color:var(--fg); }
    header { position:sticky; top:0; backdrop-filter:saturate(120%) blur(8px); background:rgba(11,11,16,.7); border-bottom:1px solid var(--ring); z-index:10; }
    .wrap { max-width:1180px; margin:0 auto; padding:16px 20px; }
    h1 { font-size:22px; margin:0 0 12px; display:flex; align-items:center; gap:10px; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    input,select { background:#0f1420; color:var(--fg); border:1px solid var(--ring); padding:10px 12px; border-radius:10px; outline:none; }
    input:focus,select:focus { border-color:#3b82f6; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:14px; margin-top:16px; }
    .card { background:var(--card); border:1px solid var(--ring); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; }
    .thumb { aspect-ratio: 4/3; background:#0f1420; display:grid; place-items:center; font-size:12px; color:var(--muted); text-decoration:none; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .meta { padding:12px 14px; display:flex; flex-direction:column; gap:6px; }
    .name { font-weight:600; font-size:14px; line-height:1.35; word-break:break-all; }
    .sub { color:var(--muted); font-size:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { background:#192034; border:1px solid var(--ring); color:#eaeaea; padding:8px 10px; border-radius:10px; text-decoration:none; font-size:12px; }
    .btn:hover { border-color:#3b82f6; }
    footer { color:var(--muted); font-size:12px; text-align:center; padding:24px 0 40px; }
    .empty { color:var(--muted); text-align:center; padding:48px 0; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ğŸ“š Books Library</h1>
    <div class="toolbar">
      <input id="q" type="search" placeholder="ê²€ìƒ‰: íŒŒì¼ëª…, í™•ì¥ì, í¬ê¸°â€¦" />
      <select id="sort">
        <option value="modifiedTime_desc">ìµœì‹ ìˆœ</option>
        <option value="modifiedTime_asc">ì˜¤ë˜ëœìˆœ</option>
        <option value="name_asc">ì´ë¦„ Aâ†’Z</option>
        <option value="name_desc">ì´ë¦„ Zâ†’A</option>
        <option value="size_desc">í¬ê¸° í°ìˆœ</option>
        <option value="size_asc">í¬ê¸° ì‘ì€ìˆœ</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">í‘œì‹œí•  PDFê°€ ì—†ìŠµë‹ˆë‹¤.</div>
</main>

<footer>
  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë”ì˜ PDFë¥¼ ì „ìì±…ì²˜ëŸ¼ ìŠ¤íŠ¸ë¦¬ë°í•©ë‹ˆë‹¤. (books.djcom.kr)
</footer>

<script src="./config.js"></script>
<script>
const { API_KEY, FOLDER_IDS, PAGE_SIZE, USE_THUMBNAIL } = window.DRIVE_CONFIG;
const DRIVE_ENDPOINT = "https://www.googleapis.com/drive/v3/files";
const el = {
  grid: document.getElementById('grid'),
  empty: document.getElementById('empty'),
  q: document.getElementById('q'),
  sort: document.getElementById('sort'),
};
let allFiles = [];

init();

async function init() {
  try{
    const res = await listFolderPdfs(FOLDER_IDS[0]);
    allFiles = res;
    render();
    el.q.addEventListener('input', render);
    el.sort.addEventListener('change', render);
  }catch(e){
    console.error(e);
    el.grid.innerHTML = '<div class="empty">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
  }
}

function render() {
  let items = [...allFiles];
  const q = el.q.value.trim().toLowerCase();
  if (q) items = items.filter(f => f.name.toLowerCase().includes(q));

  const [key, dir] = el.sort.value.split('_');
  items.sort((a,b)=>{
    if (key === 'name') {
      const r = a.name.toLowerCase().localeCompare(b.name.toLowerCase());
      return dir === 'asc' ? r : -r;
    }
    if (key === 'modifiedTime') {
      const va = new Date(a.modifiedTime).getTime();
      const vb = new Date(b.modifiedTime).getTime();
      return dir === 'asc' ? (va - vb) : (vb - va);
    }
    if (key === 'size') {
      const va = Number(a.size || 0);
      const vb = Number(b.size || 0);
      return dir === 'asc' ? (va - vb) : (vb - va);
    }
    return 0;
  });

  el.grid.innerHTML='';
  if(!items.length){el.empty.style.display='block';return;}
  el.empty.style.display='none';

  for(const f of items){
    const thumb = (USE_THUMBNAIL && f.thumbnailLink)
      ? `<img loading="lazy" src="${f.thumbnailLink}">`
      : `ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ`;

    // ë§í¬: ì¸ë„¤ì¼/ì—´ê¸° â†’ flip.html (ì±…ì²˜ëŸ¼ ë³´ê¸°)
    const flipUrl = `flip.html?id=${f.id}&name=${encodeURIComponent(f.name)}`;
    const originalUrl = `viewer.html?id=${f.id}&name=${encodeURIComponent(f.name)}`;
    const downloadUrl = `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`;

    const size = formatSize(f.size);
    const time = new Date(f.modifiedTime).toLocaleString();

    el.grid.innerHTML += `
      <div class="card">
        <a class="thumb" href="${flipUrl}" title="ì±…ì²˜ëŸ¼ ë³´ê¸°">${thumb}</a>
        <div class="meta">
          <div class="name">${f.name}</div>
          <div class="sub">${time}</div>
          <div class="row">
            <a class="btn" href="${flipUrl}">ì±…ì²˜ëŸ¼ ë³´ê¸°</a>
            <a class="btn" href="${originalUrl}">ì›ë³¸ ë³´ê¸°</a>
            <a class="btn" href="${downloadUrl}" target="_blank" rel="noopener">ë‹¤ìš´ë¡œë“œ</a>
            <span class="sub" style="margin-left:auto;">${size}</span>
          </div>
        </div>
      </div>`;
  }
}

function formatSize(n){
  n=Number(n||0);if(!n)return'-';
  const u=['B','KB','MB','GB'];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++;}
  return `${n.toFixed(1)} ${u[i]}`;
}

async function listFolderPdfs(folderId){
  const q = encodeURIComponent(`'${folderId}' in parents and mimeType='application/pdf' and trashed=false`);
  const fields = encodeURIComponent('files(id,name,modifiedTime,size,thumbnailLink)');
  const url = `${DRIVE_ENDPOINT}?key=${API_KEY}&q=${q}&fields=${fields}&pageSize=${PAGE_SIZE}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Drive API ì˜¤ë¥˜: '+r.status);
  const d = await r.json();
  return d.files || [];
}
</script>
</body>
</html>
